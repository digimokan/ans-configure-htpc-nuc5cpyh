- name: "Abort if GRUB bootloader not installed"
  block:
    - name: "Check if {{ grub_cfg_path }} exists, indicating GRUB bootloader"
      stat:
        path: "{{ grub_cfg_path }}"
      register: grub_cfg_file
    - fail:
        msg: "{{ grub_cfg_path }} not present: GRUB required to set up ucode"
      when: grub_cfg_file.stat.exists == false
  vars:
    grub_cfg_path: "/boot/grub/grub.cfg"

- name: "Set the cpu-type play fact"
  set_fact:
    cpu_type: "{{ 'amd' if amd_cpu|length > 0 else 'intel' if intel_cpu|length > 0 else 'unknown' }}"
  vars:
    intel_cpu: "{{ ansible_processor | select('match', 'Intel') | list }}"
    amd_cpu: "{{ ansible_processor | select('match', 'AMD') | list }}"

- name: "Install microcode-updates-package according to CPU type"
  block:
    - name: "Install Intel/AMD cpu-microcode-updates package"
      pacman:
        name: "{{ cpu_type }}-ucode"
        state: present
  when: cpu_type != "unknown"

